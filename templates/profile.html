{% extends 'base.html' %}
{% load static %}

{% block head %}
<title>{{ profile_user.username }}'s Profile | Blog App</title>
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        {# Assumes a profile picture, e.g., via a one-to-one Profile model #}
        <img
            src="{% if profile_user.profile.avatar %}{{ profile_user.profile.avatar.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
            alt="{{ profile_user.username }}'s avatar" class="profile-avatar">

        <div class="profile-info">
            <h1 class="profile-username">{{ user.username }}</h1>

            <p class="profile-email">{{ user.email }}</p>
            <p class="profile-joindate">Joined on
                {{user.date_joined|date:"F j, Y" }}
            </p>
            {% if user.first_name or user.last_name %}
            <p class="profile-name"><strong>Name:</strong>
                {{user.get_full_name }}</p>
            {% endif %}

            {% if user.profile.bio %}
            <p class="profile-bio"><strong>Bio:</strong>
                {{user.profile.bio }}</p>
            {% endif %}
        </div>
        <!-- Edit Mode -->
        <div class="profile-input" style="display: none;">

            <input type="text" id="edit-username" value="{{user.username}}"
                placeholder="Enter new username..." class="profile-username">

            <input type="email" id="edit-email" value="{{user.email}}"
                placeholder="Enter new email..." class="profile-email">

            <p class="profile-joindate">Joined on
                {{user.date_joined|date:"F j, Y" }}
            </p>

            <input type="text" id="edit-first-name" value="{{user.first_name}}"
                placeholder="Enter new first name..." class="profile-name">

            <input type="text" id="edit-last-name" value="{{user.last_name}}"
                placeholder="Enter new last name..." class="profile-name">

            <textarea id="edit-bio" class="profile-bio"
                placeholder="Enter something about yourself...">{{user.profile.bio}}</textarea>
        </div>

        {% if request.user == user %}
        <div class="profile-actions">
            <button class="btn" id="edit-btn">Edit Profile</button>
            <button class="btn" id="save-btn"
                style="background-color: darkred; display: none;">Save</button>
            <button class="btn" id="cancel-btn"
                style="background-color: green; display: none;">Cancel</button>
        </div>
        {% endif %}
    </div>
    {% if request.user == profile_user %}
    <div class="posts-selector">
        <button id="user-posts-btn" class="active">

            All Posts

        </button>
        <button id="user-saved-posts-btn">

            Saved Posts

        </button>
    </div>
    {% endif %}

    {% if posts %}
    <div class="posts-list" id="posts">
        <div class="user-posts">
            <h2 class="posts-title">Posts by {{ profile_user.username }}</h2>
            {% for post in posts %}
            <article class="post-item">
                <h3 class="post-title"><a
                        href="{% url 'blog_details' blog_id=post.id %}">{{post.title}}</a></h3>
                <p class="post-meta">Published on
                    {{post.created_at|date:"F j, Y"}}</p>
                <div class="post-snippet">
                    {{ post.content|safe|truncatewords:40|linebreaks }}
                </div>
                {% if request.user == profile_user %}
                <div class="post-actions">
                    <a href="{% url 'blog_details' blog_id=post.id %}"
                        class="read-more">Read more</a>

                    <form action="{% url 'delete_blog_entry' blog_id=post.id %}"
                        method="post"
                        onsubmit="return confirm('Are you sure you want to delete this post?');">
                        {% csrf_token %}
                        <button type="submit" class="btn-delete">Delete</button>
                    </form>

                    <a href="{% url 'update_blog_entry' blog_id=post.id %}"
                        class="btn-edit">Edit</a>

                </div>
                {% else %}
                <a href="{% url 'blog_details' blog_id=post.id %}"
                    class="read-more">Read more</a>
                {% endif %}
            </article>
            {% endfor %}
            {% else %}
            <p>{{ profile_user.username }} has not published any posts yet.</p>

            {% endif %}
        </div>

    </div>
    {% if request.user == profile_user %}
    {% if saved_posts %}

    <div class="posts-list" id="saved-posts">
        <div class="user-posts">
            <h2 class="posts-title">Saved Posts</h2>
            {% for post in saved_posts %}
            <article class="post-item">
                <h3 class="post-title"><a
                        href="{% url 'blog_details' blog_id=post.id %}">{{
                        post.post.title }}</a></h3>
                <p class="post-meta">
                    By {{ post.user.username }} on
                    {{post.created_at|date:"F j, Y" }}
                </p>
                <div class="post-snippet">
                    {{ post.content|safe|truncatewords:40|linebreaks }}
                </div>
                <div class="post-actions">
                    <a href="{% url 'blog_details' blog_id=post.id %}"
                        class="read-more">Read more</a>
                    <form action="{% url 'profile' username=None %}"
                        method="post"
                        class="unsave-form">
                        {% csrf_token %}
                        <input type="hidden" name="unsave_post_id"
                            value="{{ post.id }}">
                        <button type="submit"
                            class="btn-delete">Unsave</button>
                    </form>

                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <p>You have not saved any posts yet.</p>
        {% endif %} {# end if saved_posts #}
    </div>
    {% endif %} {# end if request.user == profile_user for saved posts #}
</div>
<script>
    function switchUserPost(){

        const userPostsBlock=document.querySelector("#posts");
        const savedUserPostsBlock=document.querySelector("#saved-posts");
        const SavedUserPostsBtn=document.querySelector("#user-saved-posts-btn");
        const UserPostsBtn=document.querySelector("#user-posts-btn");
        UserPostsBtn.addEventListener("click", (e)=>{
            userPostsBlock.style.display="block";
            savedUserPostsBlock.style.display="none";

            UserPostsBtn.classList.add("active");
            SavedUserPostsBtn.classList.remove("active");

        })
        

        SavedUserPostsBtn.addEventListener("click", (e)=>{
            userPostsBlock.style.display="none";
            savedUserPostsBlock.style.display="block";

            UserPostsBtn.classList.remove("active");
            SavedUserPostsBtn.classList.add("active");

        })



    }



    function switchUserEditMode(){
        const editBtn=document.querySelector("#edit-btn");
        const saveBtn=document.querySelector("#save-btn");
        const cancelBtn=document.querySelector("#cancel-btn");

        const infoBlock=document.querySelector(".profile-info");
        const inputBlock=document.querySelector(".profile-input");

        editBtn.addEventListener("click", ()=>{
            infoBlock.style.display="none";
            editBtn.style.display="none";

            inputBlock.style.display="block";
            saveBtn.style.display="block";
            cancelBtn.style.display="block";
        });

        cancelBtn.addEventListener("click", ()=>{
            infoBlock.style.display="block";
            editBtn.style.display="block";

            inputBlock.style.display="none";
            saveBtn.style.display="none";
            cancelBtn.style.display="none";
        });
    }

    function saveUserUpdates(){
        const saveBtn=document.querySelector("#save-btn");

        const usernameField=document.querySelector("#edit-username");
        const emailField=document.querySelector("#edit-email");
        const firstNameField=document.querySelector("#edit-first-name");
        const lastNameField=document.querySelector("#edit-last-name");
        const bioField=document.querySelector("#edit-bio");

        saveBtn.addEventListener("click", ()=>{
            const new_data={
                username:usernameField.value.trim(),
                email:emailField.value.trim(),
                firstName:firstNameField.value.trim(),
                lastName:lastNameField.value.trim(),
                bioField:bioField.value.trim()
            }
            console.log("New user data: ", new_data);
            const url="{% url 'update_profile' %}"
            try{
                fetch(url, {
                    method:"POST",
                    body:JSON.stringify(new_data),
                    headers:{
                        "Content-Type":"application/json",
                        "X-CSRFToken":"{{ csrf_token }}"
                    }

                })
                .then(response=>response.json())
                .then(data=>{
                    console.log("User updated:", data);
                    if (data.success){
                        console.log("Updated successfully!");
                        updateUserDetails(data.user);
                        const cancelBtn=document.querySelector("#cancel-btn");
                        cancelBtn.click();
                    }else{
                        const error=data.error;
                        console.log("Failed update user. Error:",error);
                        alert(error);
                    }
                });
            }catch(e){
                console.error("Error save user updates:", e);
            }
        });

    }
    function updateUserDetails(user){
        const htmlContent=`
            
                <h1 class="profile-username">${ user.username }</h1>

                <p class="profile-email">${ user.email }</p>
                <p class="profile-joindate">Joined on
                    {{user.date_joined|date:"F j, Y" }}
                </p>
            
                <p class="profile-name"><strong>Name:</strong>
                    ${user.firstName||""}  ${user.lastName||""}
                </p>
                
                <p class="profile-bio"><strong>Bio:</strong>
                    ${user.bio }
                </p>
            
        `;

        const profileInfo=document.querySelector(".profile-info");
        profileInfo.innerHTML=htmlContent;
    }
    document.addEventListener("DOMContentLoaded", (e)=>{
        switchUserEditMode();
        switchUserPost();
        saveUserUpdates();
    });
</script>

{% endblock %}